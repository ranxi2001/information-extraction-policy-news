<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/3d-force-graph"></script>
    <title>NER Visualization Demo</title>
</head>
<body>
    <div class="container-fluid">
        <div class="row h-100">
            <div class="col-md-4 h-100">
                <div id="input"  class="h-50 mb-2">
                    <div class="card-header">
                        Input
                    </div>
                    <div class="card-body">
                        <textarea id="inputText" rows="7" cols="70" class="form-control mb-3"></textarea>
                        <button onclick="visualizeEntities()" class="btn btn-primary">Visualize Entities</button>
                    </div>
                </div>
                <div id="output-text" class="h-50">
                    <div class="card-header">
                        Output-text
                    </div>
                    <div id="output"></div>
                </div>
            </div>
            <div class="col-md-8 h-100">
                <div id="output-3d" class="h-100">
                    <div class="card-header">
                        Output-graph
                    </div>
                    <div id="output3d"></div>
                </div>
            </div>
        </div>
    </div>


    <script>
        'use strict';

        class displaCyENT {
            constructor (options) {
                this.container = document.querySelector(options.container || '#output');
            }
            render(text, spans, ents) {
                this.container.innerHTML = '';
                let offset = 0;

                spans.forEach(({ label, start, end }) => {
                    const entity = text.slice(start, end);

                    const fragments = text.slice(offset, start).split('\n');
                    console.log(entity,fragments);
                    fragments.forEach((fragment, i) => {

                        this.container.appendChild(document.createTextNode(fragment));
                        if(fragments.length > 1 && i != fragments.length - 1) this.container.appendChild(document.createElement('br'));
                    });

                    if(ents.includes(label.toLowerCase())) {
                        const mark = document.createElement('mark');
                        mark.setAttribute('data-entity', label.toLowerCase());
                        mark.appendChild(document.createTextNode(entity));
                        this.container.appendChild(mark);
                    }

                    else {
                        this.container.appendChild(document.createTextNode(entity));
                    }

                    offset = end;
                });

                this.container.appendChild(document.createTextNode(text.slice(offset, text.length)));

                //console.log(`%cðŸ’¥  HTML markup\n%c<div class="entities">${this.container.innerHTML}</div>`, 'font: bold 16px/2 arial, sans-serif', 'font: 13px/1.5 Consolas, "Andale Mono", Menlo, Monaco, Courier, monospace');

                if(typeof this.onRender === 'function') this.onRender();
            }
        }

            function visualizeEntities() {
                const text = document.getElementById('inputText').value;
                fetch('http://127.0.0.1:888', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ text: text })
                })
                .then(response => response.json())
                .then(data => {
                    const displacy = new displaCyENT({
                        container: '#output',
                        defaultText: text,
                        defaultEnts: data.nodes.map(e => e.label)
                    });
                    displacy.render(text, data.nodes, data.nodes.map(e => e.label));
                    const Graph = ForceGraph3D()(document.getElementById('output3d'));
                    Graph.graphData(data);
                    Graph.nodeAutoColorBy('label');
                    Graph.nodeLabel(node => `NodeID: ${node.start}<br>Text: ${node.text}<br>Label: ${node.label}<br>Probability: ${node.probability}`);
                    Graph.linkLabel(link => `Relation: ${link.relation}<br>Source: ${link.sourceText}<br>Target: ${link.targetText}`);
                    Graph.linkAutoColorBy(link => link.sourceLabel);
                    Graph.linkOpacity(0.5);
                });
            }
        </script>
</body>
</html>
