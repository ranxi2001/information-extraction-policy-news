# 使用 麒麟v10 的 paddle 版本作为基础镜像
FROM registry.baidubce.com/device/paddle-cpu:kylinv10-aarch64-gcc73

# 设置工作目录
WORKDIR /app

# 将 paddle 文件夹的内容复制到容器的 /app 目录中
COPY ./paddle /app
ENV http_proxy "http://172.17.0.1:7890"
ENV https_proxy "http://172.17.0.1:7890"
ENV no_proxy "localhost,127.0.0.1"
# 创建编译目录并编译
RUN  cd /app && \
     tar -xzf cmake-3.16.8.tar.gz && cd cmake-3.16.8 && \
     ./bootstrap && make && make install && \
     ./configure && \
     make && \
     make check

RUN  make install && \
     cd /app/Paddle && \
     mkdir build && cd build && \
     cmake .. -DPY_VERSION=3.7 -DPYTHON_EXECUTABLE=`which python3` -DWITH_ARM=ON -DWITH_TESTING=OFF -DCMAKE_BUILD_TYPE=Release -DON_INFER=ON -DWITH_XBYAK=OFF && \
     make TARGET=ARMV8 -j$(nproc) \
     --rm -it paddle_image_name /bin/bash -c "pip install -U $(ls /app/Paddle/build/python/dist/*.whl)"



# 进行简单功能的健康检查
RUN python3 -c "import paddle; paddle.utils.run_check()"

# 安装项目所需的依赖
RUN pip install --no-cache-dir -r /app/requirements.txt

# 设置 Flask 环境变量
ENV FLASK_APP=paddle-backend-api.py
ENV FLASK_RUN_HOST=0.0.0.0

# 暴露端口 8888
EXPOSE 888

# 运行 Flask 应用
CMD ["python", "/app/paddle-backend-api.py"]
